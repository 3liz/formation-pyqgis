<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8"/>
  <title>
   01-Console-Python
  </title>
  <link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/github.min.css" rel="stylesheet"/>
  <style type="text/css">
   body,table tr{background-color:#fff}table tr td,table tr th{border:1px solid #ccc;text-align:left;padding:6px 13px;margin:0}pre code,table,table tr{padding:0}hr,pre code{background:0 0}body{font:16px Helvetica,Arial,sans-serif;line-height:1.4;color:#333;word-wrap:break-word;padding:10px 15px}strong,table tr th{font-weight:700}h1{font-size:2em;margin:.67em 0;text-align:center}h2{font-size:1.75em}h3{font-size:1.5em}h4{font-size:1.25em}h1,h2,h3,h4,h5,h6{font-weight:700;position:relative;margin-top:15px;margin-bottom:15px;line-height:1.1}h1,h2{border-bottom:1px solid #eee}hr{height:0;margin:15px 0;overflow:hidden;border:0;border-bottom:1px solid #ddd}a{color:#4183C4}a.absent{color:#c00}ol,ul{padding-left:15px;margin-left:5px}ol{list-style-type:lower-roman}table tr{border-top:1px solid #ccc;margin:0}table tr:nth-child(2n){background-color:#aaa}table tr td :first-child,table tr th :first-child{margin-top:0}table tr td:last-child,table tr th :last-child{margin-bottom:0}img{max-width:100%}blockquote{padding:0 15px;border-left:4px solid #ccc}code,tt{margin:0 2px;padding:0 5px;white-space:nowrap;border:1px solid #eaeaea;background-color:#f8f8f8;border-radius:3px}pre code{margin:0;white-space:pre;border:none}.highlight pre,pre{background-color:#f8f8f8;border:1px solid #ccc;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px;border-radius:3px}
  </style>
 </head>
 <body>
  <h1>
   Introduction à la console Python dans QGIS
  </h1>
  <h2>
   La documentation et les liens utiles:
  </h2>
  <ul>
   <li>
    QGIS est composé de plusieurs centaines de classes écrites en C++.
    <br/>
    La plupart de ces classes (et donc des fonctions) sont accessibles à travers un API en Python.
    <br/>
    Comme il n'est pas possible de mémoriser entièrement l'API de QGIS, il est nécessaire de connaître la
    <br/>
    documentation et comment rechercher des informations.
   </li>
   <li>
    QGIS repose sur la librairie Qt version 5 pour l'interface graphique et sur Python version 3.
   </li>
   <li>
    Toutes les classes QGIS commencent par
    <code>
     Qgs
    </code>
    et toutes les classes Qt commencent par
    <code>
     Q
    </code>
    .
   </li>
  </ul>
  <p>
   Voici une liste de liens pour la documentation:
  </p>
  <ul>
   <li>
    <a href="https://docs.qgis.org">
     https://docs.qgis.org
    </a>
    qui regroupe:
    <ul>
     <li>
      <a href="https://docs.qgis.org/3.4/en/docs/pyqgis_developer_cookbook/">
       Le Python Cookbook https://docs.qgis.org/3.4/en/docs/pyqgis_developer_cookbook
      </a>
      (recette de cuisine)
     </li>
     <li>
      <a href="https://qgis.org/api/3.4/">
       L'API C++ https://qgis.org/api/3.4/
      </a>
     </li>
     <li>
      <a href="https://qgis.org/pyqgis/3.4/">
       L'API Python https://qgis.org/pyqgis/3.4/
      </a>
     </li>
    </ul>
   </li>
  </ul>
  <p>
   Voici une liste non exhaustive de blog-post utiles pour manipuler PyQGIS:
  </p>
  <ul>
   <li>
    <a href="https://nyalldawson.net/2016/10/speeding-up-your-pyqgis-scripts/">
     Optimisation des couches vecteurs
    </a>
   </li>
   <li>
    <a href="https://www.lutraconsulting.co.uk/blog/2014/07/06/qgis-layer-tree-api-part-1/">
     Parcourir la légende en 3 parties
    </a>
   </li>
   <li>
    <a href="http://www.qgistutorials.com/en/docs/3/processing_python_plugin.html">
     Plugin Processing
    </a>
   </li>
  </ul>
  <p>
   Autre lien pour l'apprentissage de Python (sans QGIS):
   <br/>
   *
   <a href="https://openclassrooms.com/fr/courses/235344-apprenez-a-programmer-en-python">
    https://openclassrooms.com/fr/courses/235344-apprenez-a-programmer-en-python
   </a>
  </p>
  <h2>
   Configurer le projet
  </h2>
  <ul>
   <li>
    Commencer un nouveau projet et enregistrer le.
   </li>
   <li>
    À côté du projet, ajouter le dossier provenant de OSM2Igeo, par exemple
    <code>
     201909_11_ILE_DE_FRANCE_SHP_L93_2154
    </code>
    .
   </li>
  </ul>
  <h2>
   Manipulation dans la console
  </h2>
  <ul>
   <li>
    Dans QGIS,
    <code>
     Plugins
    </code>
    -&gt;
    <code>
     Console Python
    </code>
   </li>
   <li>
    <p>
     QGIS nous donne accès au projet actuel via la classe
     <code>
      QgsProject
     </code>
    </p>
    <ul>
     <li>
      <a href="https://qgis.org/api/classQgsProject.html">
       https://qgis.org/api/classQgsProject.html
      </a>
     </li>
     <li>
      <a href="https://qgis.org/pyqgis/3.4/core/QgsProject.html">
       https://qgis.org/pyqgis/3.4/core/QgsProject.html
      </a>
     </li>
    </ul>
   </li>
   <li>
    <p>
     Dans la documentation (en C++ surtout), on remarque plusieurs sections:
    </p>
    <ul>
     <li>
      Public types
     </li>
     <li>
      Public slots
     </li>
     <li>
      Signals
     </li>
     <li>
      Public Member Functions
     </li>
     <li>
      Static Public Member Functions
     </li>
    </ul>
   </li>
   <li>
    Nous verrons progressivement ces différentes sections.
   </li>
   <li>
    Recherchons
    <code>
     filename
    </code>
    .
   </li>
  </ul>
  <pre><code class="python">QgsProject.instance().fileName()
</code></pre>
  <ul>
   <li>
    Ajoutons un titre à notre projet, recherchons donc
    <code>
     title
    </code>
    dans la page :
    <code>
     setTitle
    </code>
    .
   </li>
   <li>
    Objectif, ajouter une couche vecteur contenu dans un dossier fils:
    <ul>
     <li>
      Recherchons dans l'API le dossier racine du projet.
      <em>
       Indice
      </em>
      , en informatique, on appelle souvent cela le
      <code>
       home
      </code>
      .
     </li>
     <li>
      Nous allons utiliser le module
      <code>
       os.path
      </code>
      pour manipuler les dossiers.
     </li>
     <li>
      <a href="https://docs.python.org/3/library/os.path.html">
       https://docs.python.org/3/library/os.path.html
      </a>
     </li>
     <li>
      <code>
       join
      </code>
      ,
      <code>
       isfile
      </code>
      ,
      <code>
       isdir
      </code>
     </li>
    </ul>
   </li>
  </ul>
  <pre><code class="python">from os.path import join, isfile, isdir
racine = QgsProject.instance().homePath()
join(racine, 'nexistepas')
'/home/etienne/Documents/3liz/formation/nexistepas'
isfile(join(racine,'nexistepas'))
False
isdir(join(racine,'nexistepas'))
False
chemin = join(racine, '201909_11_ILE_DE_FRANCE_SHP_L93_2154', 'H_OSM_ADMINISTRATIF')
fichier_shape = join(chemin, 'COMMUNE.shp')
isfile(fichier_shape)
True
</code></pre>
  <ul>
   <li>
    Charger la couche vecteur à l'aide de
    <code>
     iface
    </code>
    <a href="https://qgis.org/api/classQgisInterface.html">
     QgisInterface
    </a>
    (et non pas
    <strong>
     Qgs
    </strong>
    Interface!)
   </li>
  </ul>
  <pre><code class="python">communes = iface.addVectorLayer(fichier_shape, 'communes', 'ogr')
print(communes)
</code></pre>
  <ul>
   <li>
    Charger la couche autrement (conseillé)
   </li>
  </ul>
  <pre><code class="python">communes = QgsVectorLayer(fichier_shape, 'communes', 'ogr')
communes.isValid()
QgsProject.instance().addMapLayer(communes)
</code></pre>
  <ul>
   <li>
    Explorer l'objet
    <code>
     communes
    </code>
    qui est un
    <code>
     QgsVectorLayer
    </code>
    à l'aide de la documentation pour chercher sa géométrie, le nombre d'entité.
   </li>
   <li>
    Pour la géométrie, toujours utiliser l'énumération et non pas le chiffre (explication dans l'exemple ci-dessous)
   </li>
   <li>
    Essayer d'ouvrir et de clore une session d'édition
   </li>
   <li>
    Essayer désormais de chercher son nom, la projection ou encore les seuils de visibilité de la couche.
    <br/>
    On ne les trouve pas dans la page
    <code>
     QgsVectorLayer
    </code>
    !
    <br/>
    Pour cela, il faut faire référence à la notion d'héritage en Programmation Orientée Objet.
    <br/>
    L'objet
    <code>
     QgsVectorLayer
    </code>
    hérite de
    <code>
     QgsMapLayer
    </code>
    qui est une classe commune avec
    <code>
     QgsMapLayer
    </code>
    .
   </li>
   <li>
    Objectif, ne pas afficher la couche commune pour une échelle plus petite que le
    <code>
     1:2 000 000
    </code>
    .
   </li>
  </ul>
  <h2>
   Code
  </h2>
  <p>
   Petit récapitulatif à tester pour voir si cela fonctionne correctement !
  </p>
  <pre><code class="python">from os.path import join, isfile, isdir
dossier = '201909_11_ILE_DE_FRANCE_SHP_L93_2154'
thematique = 'H_OSM_ADMINISTRATIF'
couche = 'COMMUNE'

racine = QgsProject.instance().homePath()
fichier_shape = join(racine, dossier, thematique, '{}.shp'.format(couche))
layer = QgsVectorLayer(fichier_shape, couche, 'ogr')
result = QgsProject.instance().addMapLayer(layer)

print(layer.featureCount())
print(layer.crs().authid())
print('Est en mètre : {}'.format(layer.crs().mapUnits() ==  QgsUnitTypes.DistanceMeters))
print(layer.name())
layer.setScaleBasedVisibility(True)
layer.setMaximumScale(1)
layer.setMinimumScale(2000000)
layer.triggerRepaint()
</code></pre>
  <ul>
   <li>
    Ajouter également la couche
    <code>
     ARRONDISSEMENT
    </code>
    et sélectionner la.
   </li>
  </ul>
  <h2>
   Parcourir les entités
  </h2>
  <p>
   Un raccourci a savoir, dans la console:
  </p>
  <pre><code class="python">iface.activeLayer()
</code></pre>
  <p>
   retourne la couche
   <code>
    QgsMapLayer
   </code>
   active dans la légende !
  </p>
  <p>
   On souhaite désormais itérer sur les polygones et les faire clignoter depuis la console.
   <br/>
   Nous allons donc avoir besoin de
   <code>
    getFeatures
   </code>
   .
  </p>
  <pre><code class="python">layer = iface.activeLayer()
features = layer.getFeatures()
features
feature = QgsFeature()
features.nextFeature(feature)
iface.mapCanvas().flashFeatureIds(layer, [feature.id()])
</code></pre>
  <p>
   <em>
    Note
   </em>
   , nous pouvons concaténer les deux dernières lignes à l'aide du caractère
   <code>
    ;
   </code>
   pour que cela soit plus pratique.
  </p>
  <p>
   On souhaite désormais afficher le nom des arrondissements à l'aide d'une boucle
   <code>
    for
   </code>
   .
  </p>
  <pre><code class="python">layer = iface.activeLayer()
for feature in layer.getFeatures():
    # On peut traiter l'entité courante.    
</code></pre>
  <p>
   Noter l'apparition de
   <code>
    ...
   </code>
   au lieu de
   <code>
    &gt;&gt;&gt;
   </code>
   après avoir écrit la première ligne du
   <code>
    for
   </code>
   .
   <br/>
   Il faut faire une indentation obligatoire !
  </p>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js">
  </script>
  <script>
   hljs.initHighlightingOnLoad();
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>
  <script type="text/javascript">
   MathJax.Hub.Config({"showProcessingMessages" : false,"messageStyle" : "none","tex2jax": { inlineMath: [ [ "$", "$" ] ] }});
  </script>
 </body>
</html>