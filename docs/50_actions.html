
<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8"/>
  <title>Actions</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/github.min.css" rel="stylesheet"/>
  <link href="https://docs.3liz.org/remarkable.css" rel="stylesheet"/>
  <link href="logo.png" rel="icon" type="image/png" >
 </head>
 <body>
 <header class="header-container" style="">
    <h1>Actions</h1>
 </header>
 <article>
<p><a href="./">Index</a></p>

<div class="toc"><span class="toctitle">Table of content</span><ul>
<li><a href="#les-actions">Les actions</a><ul>
<li><a href="#les-actions-par-defaut">Les actions par défaut</a></li>
<li><a href="#notre-propre-action">Notre propre action</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="les-actions">Les actions</h1>
<ul>
<li>Pour connaître le principe des actions dans QGIS, il faut se référer au manuel de QGIS :<ul>
<li><a href="https://docs.qgis.org/3.16/fr/docs/user_manual/working_with_vector/vector_properties.html#actions-properties">https://docs.qgis.org/3.16/fr/docs/user_manual/working_with_vector/vector_properties.html#actions-properties</a></li>
</ul>
</li>
<li>On souhaite pouvoir faire notre propre action pour inverser le sens d'une ligne, par exemple une rivière. </li>
<li>Ajouter la couche <code>D_OSM_HYDROGRAPHIE/CANALISATION_EAU.shp</code>, mais utilisons le script ci-dessous pour
  commencer sur un cas simple.</li>
<li>Faire un style rapide pour mettre en évidence le sens de la ligne à l'aide d'une <code>Ligne de symbole</code> dans
  l'onglet <code>Symbologie</code>.</li>
</ul>
<pre><code class="python"># Notation pour ajouter des attributs en créant une couche mémoire
river = QgsVectorLayer('MultiLineString?crs=epsg:2154&amp;field=id:integer&amp;field=name:string(20)&amp;index=yes', 'Rivers', 'memory')

QgsProject.instance().addMapLayer(river)

with edit(river):
    feature = QgsVectorLayerUtils.createFeature(river)
    feature.setAttribute('id', 0)
    feature.setAttribute('name', 'Une rivière')
    geom = QgsGeometry.fromMultiPolylineXY(
    [
        [QgsPointXY(1, 1), QgsPointXY(2, 2), QgsPointXY(3, 2), QgsPointXY(4, 1)]
    ])
    feature.setGeometry(geom)
    river.addFeature(feature)

extent = river.extent()
canvas = iface.mapCanvas()
canvas.setExtent(extent)
canvas.refresh()
</code></pre>

<h2 id="les-actions-par-defaut">Les actions par défaut</h2>
<ul>
<li>Dans la fenêtre des propriétés d'une couche vecteur, aller dans l'onglet <code>Actions</code>.</li>
<li>Cliquer sur le bouton <code>Créer les actions par défaut</code>.</li>
<li>Observons quelques actions pour comprendre le fonctionnement.</li>
</ul>
<h2 id="notre-propre-action">Notre propre action</h2>
<ul>
<li>Commençons un nouveau par un script Python classique, laissons de côté les actions pour le moment.</li>
<li>Écrire une fonction qui se charge <em>d'inverser</em> une ligne. Cette fonction prend en paramètre la couche
  vecteur et une liste d'ID des entités.</li>
<li>Il faut penser à vérifier le type exact de géométrie de nos lignes, dans les propriétés de la couche.</li>
</ul>
<pre><code class="python">def reverse_geom(layer: QgsVectorLayer, ids: list):
    &quot;&quot;&quot; Inverser le sens des différentes entités dans la couche layer.

    ids est une liste comportant les IDs des entités à inverser.
    &quot;&quot;&quot;
    pass

</code></pre>

<p>Le mot-clé <code>pass</code> est juste une instruction Python qui ne fait <strong>strictement</strong> rien mais qui permet de rendre
une ligne de code valide en respectant l'indentation. Vous pouvez la supprimer dès qu'il y a du code.</p>
<p>Il faut : </p>
<ul>
<li>Utiliser une session d'édition</li>
<li>Récupérer la géométrie, tenir compte qu'il s'agit d'une multi-ligne</li>
<li>Appliquer la fonction <code>reverse</code> en Python</li>
<li>
<p>Utiliser <code>QgsVectorLayer.changeGeometry()</code> pour changer la géométrie d'un objet</p>
</li>
<li>
<p>Solution :</p>
</li>
</ul>
<pre><code class="python">def reverse_geom(layer: QgsVectorLayer, ids: list):
    &quot;&quot;&quot; Inverser le sens des différentes entités dans la couche layer.

    ids est une liste comportant les IDs des entités à inverser.
    &quot;&quot;&quot;
    with edit(layer):
        for feature in layer.getFeatures(ids):
            geom = feature.geometry()
            lines = geom.asMultiPolyline()
            for line in lines:
                line.reverse()
            new_geom = QgsGeometry.fromMultiPolylineXY(lines)
            layer.changeGeometry(feature.id(),new_geom)

layer = iface.activeLayer()
ids = layer.selectedFeatureIds()

reverse_geom(layer, ids)
</code></pre>

<p>Incorporons ce code dans une action et adaptons le un peu :</p>
<p><img alt="Inverser canalisation" src="./media/action_inverser_ligne.png"></p>
<pre><code class="python">def reverse_geom(layer, ids):
    with edit(layer):
        for feature in layer.getFeatures(ids):
           geom = feature.geometry()
           lines = geom.asMultiPolyline()
           for line in lines:
               line.reverse() 
           new_geom = QgsGeometry.fromMultiPolylineXY(lines)
           layer.changeGeometry(feature.id(), new_geom)

layer = QgsProject.instance().mapLayer('[% @layer_id %]')
reverse_geom(layer, '[% $id %]')
</code></pre>

<p>On peut désormais cliquer sur une ligne pour automatiquement inverser une ligne.</p>
<p>Le code de l'action est enregistré dans le style QML de la couche vecteur. Il peut donc être partagé avec 
d'autres utilisateurs qui ne connaissent pas Python</p>
<p><a href="./">Index</a></p>

  </article>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/highlight.min.js">
  </script>
  <script>
   hljs.initHighlightingOnLoad();
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>
  <script type="text/javascript">
   MathJax.Hub.Config({"showProcessingMessages" : false,"messageStyle" : "none","tex2jax": { inlineMath: [ [ "$", "$" ] ] }});
  </script>
 </body>
</html>
